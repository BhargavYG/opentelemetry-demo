# Copyright The OpenTelemetry Authors
# SPDX-License-Identifier: Apache-2.0

type: Test
spec:
  id: frauddetection-order
  name: 'Fraud Detection: process order'
  description: Process an order from Orders stream
  trigger:
    type: kafka
    kafka:
      brokerUrls:
      - ${var:KAFKA_SERVICE_ADDR}
      topic: messaging
      messageKey: "order-600"
      messageValue: |
        {
          "order_id": "600",
          "shipping_tracking_id": "dead-beef",
          "shipping_cost": {
            "currency_code": "USD",
            "units": 17,
            "nanos": 980000000
          },
          "shipping_address": {
            "street_address_1": "1600 Amphitheatre Parkway",
            "city": "Mountain View",
            "state": "California",
            "country": "United States",
            "zip_code": "94043"
          },
          "items": [
            {
              "item": {
                "product_id": "1YMWWN1N4O",
                "quantity": 5
              },
              "cost": {
                "currency_code": "USD",
                "units": 100,
                "nanos": 0
              }
            }
          ]
        }

  specs:
  - name: The order was sent to fraud detection team
    # captures the span emitted by Kafka instrumentation for Kotlin
    selector: span[tracetest.span.type="messaging" name="orders process" messaging.system="kafka" messaging.operation="process"] 
    assertions:
    - attr:name = "orders process"
